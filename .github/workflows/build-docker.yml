name: Build monarch wheels and docker image without publishing

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'Wheel artifact name from build workflow'
        required: true
        type: string

jobs:
  build-docker:
    name: Build docker container
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      # This step is required to avoid the "no space left on device" error from
      # the large pytorch docker image.
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1

      - name: Checkout repository
        uses: actions/checkout@v6

      # Use the already built and tested wheels.
      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: dist

      - name: List downloaded artifacts
        run: |
          echo "Current directory: $(pwd)"
          echo ""
          echo "Top-level contents:"
          ls -la
          echo ""
          echo "Contents of dist directory:"
          ls -la dist/ || echo "dist directory not found"
          echo ""
          echo "All wheel files in workspace:"
          find . -name "*.whl" -type f 2>/dev/null || echo "No wheel files found"

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: . # Build context is the root directory
          file: ./Dockerfile.nightly
          push: false # Just building the image, not publishing
          build-args: |
            PYTORCH_TAG=2.11.0.dev20260109-cuda12.6-cudnn9-runtime
            MONARCH_WHEELS=dist
          outputs: type=docker,dest=${{ runner.temp }}/monarch_image.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: monarch-image
          path: ${{ runner.temp }}/monarch_image.tar
